

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Data for Discrete Choice &mdash; Python for Transportation 1.1.0, April 2020 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Practical Mode Choice" href="004-mtc-modechoice-practical.html" />
    <link rel="prev" title="Estimating Model Parameters" href="002-estimating-parameters.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Python for Transportation
          

          
          </a>

          
            
            
              <div class="version">
                1.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../starting/_index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic-python/_index.html">Python Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tabular-analysis/_index.html">Tabular Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/_index.html">Data Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geographic-analysis/_index.html">Geographic Analysis</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_index.html">Discrete Choice Modeling</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="001-fundamentals.html">Discrete Choice Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="002-estimating-parameters.html">Estimating Model Parameters</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Data for Discrete Choice</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Fundamental-Data-Formats">Fundamental Data Formats</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#idco-Format">idco Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#idca-Format">idca Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Data-Conversion">Data Conversion</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Data-Encoding">Data Encoding</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Categorical-Encoding">Categorical Encoding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#One-Hot-Encoding">One Hot Encoding</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Adding-on-to-Data">Adding on to Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Geocoding">Geocoding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Attaching-Skims">Attaching Skims</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Assembling-Data-for-Estimation">Assembling Data for Estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Data-Subsets">Data Subsets</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="004-mtc-modechoice-practical.html">Practical Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="005-nested-logit.html">Nested Logit</a></li>
<li class="toctree-l2"><a class="reference internal" href="101_exville_mode_choice.html">Exampville Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="102_exville_mc_logsums.html">Exampville Mode Choice Logsums</a></li>
<li class="toctree-l2"><a class="reference internal" href="103_exville_dest.html">Exampville Destination Choice</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/_index.html">Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/example-data.html">Tutorial Data Files</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Python for Transportation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="_index.html">Discrete Choice Modeling</a> &raquo;</li>
        
      <li>Data for Discrete Choice</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/course-content/choice-modeling/003-data-for-discrete-choice.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">larch</span> <span class="k">as</span> <span class="nn">larch</span>
<span class="kn">import</span> <span class="nn">transportation_tutorials</span> <span class="k">as</span> <span class="nn">tt</span>
</pre></div>
</div>
</div>
<div class="section" id="Data-for-Discrete-Choice">
<h1>Data for Discrete Choice<a class="headerlink" href="#Data-for-Discrete-Choice" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Fundamental-Data-Formats">
<h2>Fundamental Data Formats<a class="headerlink" href="#Fundamental-Data-Formats" title="Permalink to this headline">¶</a></h2>
<p>When working with discrete choice models, we will need our prepared data to be in one of two basic formats: the case-only (“idco”) format or the case-alternative (“idca”) format. This are sometimes referred to as IDCase (each record contains all the information for mode choice over alternatives for a single trip) or IDCase-IDAlt (each record contains all the information for a single alternative available to each decision maker so there is one record for each alternative for each choice).</p>
<div class="section" id="idco-Format">
<h3>idco Format<a class="headerlink" href="#idco-Format" title="Permalink to this headline">¶</a></h3>
<p>In the <strong>idco</strong> case-only format, each record provides all the relevant information about an individual choice, including the variables related to the decision maker or the choice itself, as well as alternative related variables for all available alternatives and a variable indicating which alternative was chosen.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_co</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;example-data/tiny_idco.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;caseid&#39;</span><span class="p">)</span>
<span class="n">data_co</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Income</th>
      <th>CarTime</th>
      <th>CarCost</th>
      <th>BusTime</th>
      <th>BusCost</th>
      <th>WalkTime</th>
      <th>Chosen</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>30000</td>
      <td>30</td>
      <td>150</td>
      <td>40</td>
      <td>100</td>
      <td>20</td>
      <td>Car</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30000</td>
      <td>25</td>
      <td>125</td>
      <td>35</td>
      <td>100</td>
      <td>0</td>
      <td>Bus</td>
    </tr>
    <tr>
      <th>3</th>
      <td>40000</td>
      <td>40</td>
      <td>125</td>
      <td>50</td>
      <td>75</td>
      <td>30</td>
      <td>Walk</td>
    </tr>
    <tr>
      <th>4</th>
      <td>50000</td>
      <td>15</td>
      <td>225</td>
      <td>20</td>
      <td>150</td>
      <td>10</td>
      <td>Walk</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="idca-Format">
<h3>idca Format<a class="headerlink" href="#idca-Format" title="Permalink to this headline">¶</a></h3>
<p>In the <strong>idca</strong> case-alternative format, each record can include information on the variables related to the decision maker or the choice itself, the attributes of that particular alternative, and a choice variable that indicates whether the alternative was or was not chosen.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_ca</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;example-data/tiny_idca.csv&quot;</span><span class="p">)</span>
<span class="n">data_ca</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>caseid</th>
      <th>altid</th>
      <th>Income</th>
      <th>Time</th>
      <th>Cost</th>
      <th>Chosen</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Car</td>
      <td>30000</td>
      <td>30</td>
      <td>150</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Bus</td>
      <td>30000</td>
      <td>40</td>
      <td>100</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>Walk</td>
      <td>30000</td>
      <td>20</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>Car</td>
      <td>30000</td>
      <td>25</td>
      <td>125</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>Bus</td>
      <td>30000</td>
      <td>35</td>
      <td>100</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3</td>
      <td>Car</td>
      <td>40000</td>
      <td>40</td>
      <td>125</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>3</td>
      <td>Bus</td>
      <td>40000</td>
      <td>50</td>
      <td>75</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>3</td>
      <td>Walk</td>
      <td>40000</td>
      <td>30</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>4</td>
      <td>Car</td>
      <td>50000</td>
      <td>15</td>
      <td>225</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>4</td>
      <td>Bus</td>
      <td>50000</td>
      <td>20</td>
      <td>150</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>4</td>
      <td>Walk</td>
      <td>50000</td>
      <td>10</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">idca</span></code> format actually has two technical variations, a sparse version and a dense version. The table shown above is a sparse version, where any alterative that is not available is simply missing from the data table. Thus, in caseid 2 above, there are only 2 rows, not 3. By dropping these rows, this data storage is potentially more efficient than the dense version. But, in cases where the number of missing alternatives is managably small (less than half of all the data, certainly) it can be
much more computationally efficient to simply store and work with the dense array.</p>
<blockquote>
<div><p>In <em>Larch</em>, these two distinct sub-types of idca data are labeled so that the dense version labeled as <code class="docutils literal notranslate"><span class="pre">idca</span></code> and the sparse version labeled as <code class="docutils literal notranslate"><span class="pre">idce</span></code>.</p>
</div></blockquote>
</div>
<div class="section" id="Data-Conversion">
<h3>Data Conversion<a class="headerlink" href="#Data-Conversion" title="Permalink to this headline">¶</a></h3>
<p>Converting between <code class="docutils literal notranslate"><span class="pre">idca</span></code> format data and <code class="docutils literal notranslate"><span class="pre">idco</span></code> format in Python can be super easy if the alternative id’s are stored appropriately in a two-level MultiIndex. In that case, we can simply <code class="docutils literal notranslate"><span class="pre">stack</span></code> or <code class="docutils literal notranslate"><span class="pre">unstack</span></code> the DataFrame, and change formats. This is typically more readily available when switching from <code class="docutils literal notranslate"><span class="pre">idca</span></code> to <code class="docutils literal notranslate"><span class="pre">idco</span></code> formats, as the alterative id’s typically appear in a column of the DataFrame that can be used for indexing.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_ca</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;caseid&#39;</span><span class="p">,</span> <span class="s1">&#39;altid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">Income</th>
      <th colspan="3" halign="left">Time</th>
      <th colspan="3" halign="left">Cost</th>
      <th colspan="3" halign="left">Chosen</th>
    </tr>
    <tr>
      <th>altid</th>
      <th>Bus</th>
      <th>Car</th>
      <th>Walk</th>
      <th>Bus</th>
      <th>Car</th>
      <th>Walk</th>
      <th>Bus</th>
      <th>Car</th>
      <th>Walk</th>
      <th>Bus</th>
      <th>Car</th>
      <th>Walk</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>30000.0</td>
      <td>30000.0</td>
      <td>30000.0</td>
      <td>40.0</td>
      <td>30.0</td>
      <td>20.0</td>
      <td>100.0</td>
      <td>150.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30000.0</td>
      <td>30000.0</td>
      <td>NaN</td>
      <td>35.0</td>
      <td>25.0</td>
      <td>NaN</td>
      <td>100.0</td>
      <td>125.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>40000.0</td>
      <td>40000.0</td>
      <td>40000.0</td>
      <td>50.0</td>
      <td>40.0</td>
      <td>30.0</td>
      <td>75.0</td>
      <td>125.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>50000.0</td>
      <td>50000.0</td>
      <td>50000.0</td>
      <td>20.0</td>
      <td>15.0</td>
      <td>10.0</td>
      <td>150.0</td>
      <td>225.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Getting our original <code class="docutils literal notranslate"><span class="pre">idco</span></code> data into <code class="docutils literal notranslate"><span class="pre">idca</span></code> format is not so clean, as there’s no analagous <code class="docutils literal notranslate"><span class="pre">set_columns</span></code> method in pandas, and even if there were, the alternative codes are not typically neatly arranged in a row of data. We can force it to work, but it’s not pretty.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">forced_ca</span> <span class="o">=</span> <span class="n">data_co</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
<span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">([</span>
    <span class="p">[</span><span class="s1">&#39;Car&#39;</span><span class="p">,</span> <span class="s1">&#39;Income&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Car&#39;</span><span class="p">,</span><span class="s1">&#39;Time&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Car&#39;</span><span class="p">,</span><span class="s1">&#39;Cost&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Bus&#39;</span><span class="p">,</span><span class="s1">&#39;Time&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Bus&#39;</span><span class="p">,</span><span class="s1">&#39;Cost&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Walk&#39;</span><span class="p">,</span><span class="s1">&#39;Time&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;Car&#39;</span><span class="p">,</span> <span class="s1">&#39;Chosen&#39;</span><span class="p">],</span>
<span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span><span class="s1">&#39;var&#39;</span><span class="p">))</span>
<span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">forced_ca</span><span class="p">[[</span><span class="s1">&#39;Chosen&#39;</span><span class="p">,</span> <span class="s1">&#39;Income&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">forced_ca</span><span class="p">[[</span><span class="s1">&#39;Chosen&#39;</span><span class="p">,</span> <span class="s1">&#39;Income&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;caseid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">forced_ca</span><span class="p">[</span><span class="s1">&#39;Chosen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">forced_ca</span><span class="p">[</span><span class="s1">&#39;Chosen&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">forced_ca</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;alt&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">forced_ca</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>var</th>
      <th>Chosen</th>
      <th>Cost</th>
      <th>Income</th>
      <th>Time</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th>alt</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">1</th>
      <th>Bus</th>
      <td>0.0</td>
      <td>100</td>
      <td>30000</td>
      <td>40</td>
    </tr>
    <tr>
      <th>Car</th>
      <td>1.0</td>
      <td>150</td>
      <td>30000</td>
      <td>30</td>
    </tr>
    <tr>
      <th>Walk</th>
      <td>0.0</td>
      <td>NaN</td>
      <td>30000</td>
      <td>20</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">2</th>
      <th>Bus</th>
      <td>1.0</td>
      <td>100</td>
      <td>30000</td>
      <td>35</td>
    </tr>
    <tr>
      <th>Car</th>
      <td>0.0</td>
      <td>125</td>
      <td>30000</td>
      <td>25</td>
    </tr>
    <tr>
      <th>Walk</th>
      <td>0.0</td>
      <td>NaN</td>
      <td>30000</td>
      <td>0</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">3</th>
      <th>Bus</th>
      <td>0.0</td>
      <td>75</td>
      <td>40000</td>
      <td>50</td>
    </tr>
    <tr>
      <th>Car</th>
      <td>0.0</td>
      <td>125</td>
      <td>40000</td>
      <td>40</td>
    </tr>
    <tr>
      <th>Walk</th>
      <td>1.0</td>
      <td>NaN</td>
      <td>40000</td>
      <td>30</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">4</th>
      <th>Bus</th>
      <td>0.0</td>
      <td>150</td>
      <td>50000</td>
      <td>20</td>
    </tr>
    <tr>
      <th>Car</th>
      <td>0.0</td>
      <td>225</td>
      <td>50000</td>
      <td>15</td>
    </tr>
    <tr>
      <th>Walk</th>
      <td>1.0</td>
      <td>NaN</td>
      <td>50000</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The good news is that it’s not generally necessary to swap the data formats when working with Larch for discrete choice models, as Larch can natively handle both formats of data.</p>
</div>
</div>
<div class="section" id="Data-Encoding">
<h2>Data Encoding<a class="headerlink" href="#Data-Encoding" title="Permalink to this headline">¶</a></h2>
<p>For the most part, data used in the utility functions of discrete choice models enters into the utility function as part of a linear-in-parameters function. That is, we have some “data” that expresses an attribute of some part of the transportation system as a number, we multiply that by some numerical parameter that will be estimated, and we sum up the total over all the data-times-parameter operations. This kind of structure is known as “linear algebra” and it’s something computers can do
super fast, as long as all the data and all the parameters are queued up in memory in the right formats. So, typically it is optimal to pre-compute the “data” part of the process into one large contiguous array of floating point values, regardless if the values otherwise seem to be binary or integers. Most tools, such as Larch, will do much of this work for you, so you don’t need to worry about it too much.</p>
<p>There are two notable exceptions to this guideline:</p>
<ul class="simple">
<li><p><em>choices</em>: the data that represents the observed choices, which are inherently categorical</p></li>
<li><p><em>availablity</em>: data that represents the availability of each choice, which is inherently boolean</p></li>
</ul>
<div class="section" id="Categorical-Encoding">
<h3>Categorical Encoding<a class="headerlink" href="#Categorical-Encoding" title="Permalink to this headline">¶</a></h3>
<p>When we are looking at discrete choices, it is natural to employ a categorical data type for at least the “choice” data itself, if not for other columns as well. Pandas can convert columns to categorical data simply by assigning the type “category”.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">choices</span> <span class="o">=</span> <span class="n">data_co</span><span class="p">[</span><span class="s1">&#39;Chosen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<span class="n">choices</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
caseid
1     Car
2     Bus
3    Walk
4    Walk
Name: Chosen, dtype: category
Categories (3, object): [&#39;Bus&#39;, &#39;Car&#39;, &#39;Walk&#39;]
</pre></div></div>
</div>
<p>Once we have categorical data, if we like we can work with the underlying code values instead of the original raw data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">choices</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
caseid
1    1
2    0
3    2
4    2
dtype: int8
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cat.categories</span></code> attribute contains the array of values matching each of the code.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">choices</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Index([&#39;Bus&#39;, &#39;Car&#39;, &#39;Walk&#39;], dtype=&#39;object&#39;)
</pre></div></div>
</div>
<p>When using <code class="docutils literal notranslate"><span class="pre">astype(&quot;category&quot;)</span></code> there’s no control over the ordering of the categories. If we want to control the apparent order (e.g. we already have codes defined elsewhere such that Car is 1, Bus is 2, and walk is 3) then we can explicitly set the category value positions using <code class="docutils literal notranslate"><span class="pre">pd.CategoricalDtype</span></code> instead of <code class="docutils literal notranslate"><span class="pre">&quot;category&quot;</span></code>. Note that the <code class="docutils literal notranslate"><span class="pre">cat.codes</span></code> numbers used internally by categoricals start with zero as standard in Python, so if you want codes to start with 1 you need to include a
dummy placeholder for zero.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">choices1</span> <span class="o">=</span> <span class="n">data_co</span><span class="p">[</span><span class="s1">&#39;Chosen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">([</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;Car&#39;</span><span class="p">,</span><span class="s1">&#39;Bus&#39;</span><span class="p">,</span><span class="s1">&#39;Walk&#39;</span><span class="p">]))</span>
<span class="n">choices1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
caseid
1     Car
2     Bus
3    Walk
4    Walk
Name: Chosen, dtype: category
Categories (4, object): [&#39;_&#39;, &#39;Car&#39;, &#39;Bus&#39;, &#39;Walk&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">choices1</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
caseid
1    1
2    2
3    3
4    3
dtype: int8
</pre></div></div>
</div>
<p>To be clear, by asserting the <em>placement</em> ordering of alternative like this, we are not simultaneously asserting that the alternatives are ordinal. Put another way, we are forcing Car to be coded as 1 and Bus to be coded as 2, but we are not saying that Car is less than Bus. Pandas categoricals can allow this, by adding <code class="docutils literal notranslate"><span class="pre">ordered=True</span></code> to the CategoricalDtype.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">([</span><span class="s1">&#39;NoCars&#39;</span><span class="p">,</span><span class="s1">&#39;1Car&#39;</span><span class="p">,</span><span class="s1">&#39;2Cars&#39;</span><span class="p">,</span><span class="s1">&#39;3+Cars&#39;</span><span class="p">],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CategoricalDtype(categories=[&#39;NoCars&#39;, &#39;1Car&#39;, &#39;2Cars&#39;, &#39;3+Cars&#39;], ordered=True)
</pre></div></div>
</div>
</div>
<div class="section" id="One-Hot-Encoding">
<h3>One Hot Encoding<a class="headerlink" href="#One-Hot-Encoding" title="Permalink to this headline">¶</a></h3>
<p>One-hot encoding, also known as dummy variables, is the creation of a seperate binary-valued column for every categorical value. We can convert a categorical data column into a set of one-hot encoded columns using the <code class="docutils literal notranslate"><span class="pre">get_dummies</span></code> function.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Bus</th>
      <th>Car</th>
      <th>Walk</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>It’s not required to have first converted the data to a categorical data type.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">data_co</span><span class="p">[</span><span class="s1">&#39;Chosen&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Bus</th>
      <th>Car</th>
      <th>Walk</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
</div>
<div class="section" id="Adding-on-to-Data">
<h2>Adding on to Data<a class="headerlink" href="#Adding-on-to-Data" title="Permalink to this headline">¶</a></h2>
<p>If you’ve seen a number of household travel surveys, you know that they typically include several tables of data, for households, persons, trips, and sometimes other things like vehicles. The tables reveal the actual (or at least, reported as actual) travel behaviors of people: where do they go, when, by what mode, et cetera. But these table don’t always contain all the data we need to build or use a discrete choice model. It’s not enough to know the factual data (I drove to work, it took 35
minutes and cost \$3.50 in gas and tolls), we also need counter-factual data (I didn’t take the train, which would have taken 40 minutes and cost \$2). We can pull this counter-factual data out of model representations of all the various transportation options, but to do so we’ll need to interface our survey data with our model data.</p>
<div class="section" id="Geocoding">
<h3>Geocoding<a class="headerlink" href="#Geocoding" title="Permalink to this headline">¶</a></h3>
<p>One of the first things we might need to do is to geocode trip ends. Often this gets done relatively early in data processing, and TAZ ID’s for origin and destination may already be attached. But if that’s not already done, we can do it in Python.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trips</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;example-data/tiny_points.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;caseid&#39;</span><span class="p">)</span>
<span class="n">trips</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>orig_x</th>
      <th>orig_y</th>
      <th>dest_x</th>
      <th>dest_y</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>946907</td>
      <td>925689</td>
      <td>884665</td>
      <td>494832</td>
    </tr>
    <tr>
      <th>2</th>
      <td>952193</td>
      <td>945628</td>
      <td>892053</td>
      <td>478115</td>
    </tr>
    <tr>
      <th>3</th>
      <td>889200</td>
      <td>491106</td>
      <td>959298</td>
      <td>919813</td>
    </tr>
    <tr>
      <th>4</th>
      <td>877274</td>
      <td>476391</td>
      <td>947965</td>
      <td>925746</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>If we have a shapefile for the TAZ’s, we can map those points to the locations and attach the TAZ codes directly to the DataFrame. For this geographic task, we’ll use the <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> package, and that shapefile.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="n">taz_shp</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s2">&quot;SERPM8-TAZSHAPE&quot;</span><span class="p">))</span>
<span class="n">taz_shp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>OBJECTID</th>
      <th>TAZ_REG</th>
      <th>TAZ_OLD05</th>
      <th>TAZ_MPO</th>
      <th>COUNTY</th>
      <th>CENSUSTAZ</th>
      <th>TAZ_BF</th>
      <th>FIX</th>
      <th>AREA</th>
      <th>F_NETAREA</th>
      <th>CBD</th>
      <th>HM_ROOMS</th>
      <th>Shape_Leng</th>
      <th>Shape_Area</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1122.0</td>
      <td>1122</td>
      <td>1122</td>
      <td>1.0</td>
      <td>None</td>
      <td>0</td>
      <td>0</td>
      <td>4442490.0</td>
      <td>0.8153</td>
      <td>0</td>
      <td>0</td>
      <td>10592.846522</td>
      <td>4.442490e+06</td>
      <td>POLYGON ((936374.674 959539.568, 936373.444 95...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>17.0</td>
      <td>17</td>
      <td>17</td>
      <td>1.0</td>
      <td>None</td>
      <td>0</td>
      <td>0</td>
      <td>15689400.0</td>
      <td>0.8571</td>
      <td>0</td>
      <td>0</td>
      <td>17396.297932</td>
      <td>1.568938e+07</td>
      <td>POLYGON ((942254.500 952920.937, 942255.812 95...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1123.0</td>
      <td>1123</td>
      <td>1123</td>
      <td>1.0</td>
      <td>None</td>
      <td>0</td>
      <td>0</td>
      <td>17396100.0</td>
      <td>0.8663</td>
      <td>0</td>
      <td>0</td>
      <td>23585.421941</td>
      <td>1.739613e+07</td>
      <td>POLYGON ((940953.561 952985.069, 940953.437 95...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1120.0</td>
      <td>1120</td>
      <td>1120</td>
      <td>1.0</td>
      <td>None</td>
      <td>0</td>
      <td>0</td>
      <td>1303420.0</td>
      <td>0.8536</td>
      <td>0</td>
      <td>0</td>
      <td>7202.864864</td>
      <td>1.303422e+06</td>
      <td>POLYGON ((953119.000 951985.375, 953045.807 95...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>1121.0</td>
      <td>1121</td>
      <td>1121</td>
      <td>1.0</td>
      <td>None</td>
      <td>0</td>
      <td>0</td>
      <td>31477500.0</td>
      <td>0.8787</td>
      <td>0</td>
      <td>0</td>
      <td>24940.959492</td>
      <td>3.147748e+07</td>
      <td>POLYGON ((934328.283 951600.585, 934327.451 94...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>To compelete the geocoding, first we need to assemble the latitude and longitude (or x and y) columns into an array of points.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trips_orig_points_array</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span>
    <span class="n">trips</span><span class="o">.</span><span class="n">orig_x</span><span class="p">,</span> <span class="n">trips</span><span class="o">.</span><span class="n">orig_y</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">taz_shp</span><span class="o">.</span><span class="n">crs</span>
<span class="p">)</span>
<span class="n">trips_orig_points_array</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;GeometryArray&gt;
[&lt;shapely.geometry.point.Point object at 0x7fa9202f03d0&gt;,
 &lt;shapely.geometry.point.Point object at 0x7fa9202f0400&gt;,
 &lt;shapely.geometry.point.Point object at 0x7fa9202f00a0&gt;,
 &lt;shapely.geometry.point.Point object at 0x7fa9202f04c0&gt;]
Length: 4, dtype: geometry
</pre></div></div>
</div>
<p>Then, we wrap that array into a GeoDataFrame, attaching the same <code class="docutils literal notranslate"><span class="pre">index</span></code> as on our original <code class="docutils literal notranslate"><span class="pre">trips</span></code> table.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trips_orig_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="n">geometry</span><span class="o">=</span><span class="n">trips_orig_points_array</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="n">trips</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">trips_orig_points</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>POINT (946907.000 925689.000)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POINT (952193.000 945628.000)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POINT (889200.000 491106.000)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POINT (877274.000 476391.000)</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Finally, we run a spatial join (<code class="docutils literal notranslate"><span class="pre">sjoin</span></code>) between that GeoDataFrame and the TAZ shapes, joining using the ‘within’ operator. We’ll take the <code class="docutils literal notranslate"><span class="pre">TAZ_MPO</span></code> field from the result, and write that to the trips DataFrame as the origin TAZ.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trips</span><span class="p">[</span><span class="s1">&#39;otaz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
    <span class="n">trips_orig_points</span><span class="p">,</span> <span class="n">taz_shp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s1">&#39;within&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">TAZ_MPO</span>
<span class="n">trips</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>orig_x</th>
      <th>orig_y</th>
      <th>dest_x</th>
      <th>dest_y</th>
      <th>otaz</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>946907</td>
      <td>925689</td>
      <td>884665</td>
      <td>494832</td>
      <td>1129</td>
    </tr>
    <tr>
      <th>2</th>
      <td>952193</td>
      <td>945628</td>
      <td>892053</td>
      <td>478115</td>
      <td>1141</td>
    </tr>
    <tr>
      <th>3</th>
      <td>889200</td>
      <td>491106</td>
      <td>959298</td>
      <td>919813</td>
      <td>1132</td>
    </tr>
    <tr>
      <th>4</th>
      <td>877274</td>
      <td>476391</td>
      <td>947965</td>
      <td>925746</td>
      <td>1149</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We can do the same for the destination TAZ, all in one fell swoop.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trips</span><span class="p">[</span><span class="s1">&#39;dtaz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
    <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span>
            <span class="n">trips</span><span class="o">.</span><span class="n">dest_x</span><span class="p">,</span> <span class="n">trips</span><span class="o">.</span><span class="n">dest_y</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">taz_shp</span><span class="o">.</span><span class="n">crs</span>
        <span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">trips</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">taz_shp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s1">&#39;within&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">TAZ_MPO</span>

<span class="n">trips</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>orig_x</th>
      <th>orig_y</th>
      <th>dest_x</th>
      <th>dest_y</th>
      <th>otaz</th>
      <th>dtaz</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>946907</td>
      <td>925689</td>
      <td>884665</td>
      <td>494832</td>
      <td>1129</td>
      <td>1122</td>
    </tr>
    <tr>
      <th>2</th>
      <td>952193</td>
      <td>945628</td>
      <td>892053</td>
      <td>478115</td>
      <td>1141</td>
      <td>1136</td>
    </tr>
    <tr>
      <th>3</th>
      <td>889200</td>
      <td>491106</td>
      <td>959298</td>
      <td>919813</td>
      <td>1132</td>
      <td>1144</td>
    </tr>
    <tr>
      <th>4</th>
      <td>877274</td>
      <td>476391</td>
      <td>947965</td>
      <td>925746</td>
      <td>1149</td>
      <td>1129</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Attaching-Skims">
<h3>Attaching Skims<a class="headerlink" href="#Attaching-Skims" title="Permalink to this headline">¶</a></h3>
<p>After attaching our trip end zone id’s, we’re ready to pull in the level-of-service (LOS) attributes for the various alternatives. Many times, these LOS attributes come in the form of “skims”. Skims are typically a bunch of square arrays, showing the cost or time or other level of service attributes between origins and destinations. They come in a variety of formats, although it is increasingly common to see “openmatrix” (OMX) or <code class="docutils literal notranslate"><span class="pre">.omx</span></code> files used to exchange skim data between different tools.
To read OMX files in Python, we can use the <code class="docutils literal notranslate"><span class="pre">openmatrix</span></code> package, or an optimized OMX reader that’s build in to Larch.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">skims</span> <span class="o">=</span> <span class="n">larch</span><span class="o">.</span><span class="n">OMX</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s1">&#39;SERPM8-JUPITER-AMHSKIMS&#39;</span><span class="p">))</span>
<span class="n">skims</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;larch.OMX&gt; ⋯/SERPM8-JUPITER-AMHSKIMS.omx
 |  shape:(220, 220)
 |  data:
 |    AM_DAT_DIST      (float64)
 |    AM_DAT_FFTIME    (float64)
 |    AM_DAT_TIME      (float64)
 |    AM_DAT_TOLLCOST  (float64)
 |    AM_DAT_TOLLDIST  (float64)
 |    AM_GP_DIST       (float64)
 |    AM_GP_FFTIME     (float64)
 |    AM_GP_TIME       (float64)
 |    AM_S2NH_DIST     (float64)
 |    AM_S2NH_FFTIME   (float64)
 |    AM_S2NH_HOVDIST  (float64)
 |    AM_S2NH_TIME     (float64)
 |    AM_S2TH_DIST     (float64)
 |    AM_S2TH_FFTIME   (float64)
 |    AM_S2TH_HOVDIST  (float64)
 |    AM_S2TH_TIME     (float64)
 |    AM_S2TH_TOLLCOST (float64)
 |    AM_S2TH_TOLLDIST (float64)
 |  lookup:
 |    TAZ_ID (220 int64)
</pre></div></div>
</div>
<p>The OMX file can contain two different sets of data. The “data” includes all the various LOS attributes, in a bunch of square arrays. The “lookup” includes one-dimensional arrays (vectors) that can include both meaningful data (e.g. hourly parking costs by zone) as well as metadata (e.g. the TAZ ID’s). In the file we’re opened, there’s only those ID’s. We can get a little more technical detail about each data item by inspecting them individually in our Jupyter notebook.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">skims</span><span class="o">.</span><span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;TAZ_ID&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/lookup/TAZ_ID (CArray(220,), shuffle, zlib(1)) &#39;&#39;
  atom := Int64Atom(shape=(), dflt=0)
  maindim := 0
  flavor := &#39;numpy&#39;
  byteorder := &#39;little&#39;
  chunkshape := (8192,)
</pre></div></div>
</div>
<p>If we add a slice all operation (<code class="docutils literal notranslate"><span class="pre">[:]</span></code>) we can load the actual data into memory as a numpy array.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">skims</span><span class="o">.</span><span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;TAZ_ID&#39;</span><span class="p">][:]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([   1,    2,    3,    4,    5,    6,    7,    8,    9,   10,   11,
         12,   13,   14,   15,   16,   17,   18,   19,   20,   21,   22,
         23,   24,   25,   26,   27,   28,   29,   30,   31,   32,   33,
         34,   35,   36,   37,   38,   39,   40,   41,   42,   43,   44,
         45,   46,   47,   48,   49,   50,   51,   52,   53,   54,   55,
         56,   57,   58,   59,   60,   61,   62,   63,   64,   65,   66,
         67,   68,   69,   70,   71,   72,   73,   74,   75,   80,   81,
         82,   83,   84,   87,   88,   89,   90,   91,   92,   93,   95,
         98,   99,  100,  101,  102,  103,  792,  793,  794,  795,  796,
        797,  798,  799,  800,  825,  831,  832,  833,  834,  835,  836,
        837,  838,  839,  840,  841,  842,  843,  844,  845,  846,  847,
        848,  849,  850,  851,  852,  853,  885,  886,  887,  888,  889,
        890,  891,  892,  893, 1067, 1068, 1103, 1104, 1105, 1106, 1120,
       1121, 1122, 1123, 1124, 1125, 1126, 1127, 1128, 1129, 1130, 1131,
       1132, 1133, 1134, 1135, 1136, 1137, 1138, 1139, 1140, 1141, 1142,
       1143, 1144, 1145, 1146, 1147, 1148, 1149, 1150, 1151, 1152, 1153,
       1154, 1155, 1156, 1157, 1158, 1159, 1160, 1161, 1162, 1163, 1164,
       1165, 1166, 1167, 1168, 1169, 1170, 1171, 1477, 1478, 1503, 1504,
       1505, 1506, 1507, 1508, 1509, 1510, 1518, 1519, 1520, 1521, 1522,
       1523, 1543, 1544, 1546, 1547, 1567, 1568, 1569, 1570, 1571, 1588])
</pre></div></div>
</div>
<p>This OMX file only includes skims between 220 zones around Jupiter, and not the whole SERPM region, so the TAZ ID’s are not a contiguous set of integers. Therefore, if we want to work with this data we have to map our known TAZ ID’s to this discontinuous set. Even if it was continuous, we’d still need to create a mapping, as TAZ ID’s typically start at 1 but array indexing in Python starts at zero.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">taz_idx_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skims</span><span class="o">.</span><span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;TAZ_ID&#39;</span><span class="p">])}</span>
<span class="n">trips</span><span class="p">[</span><span class="s1">&#39;otaz_ix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trips</span><span class="p">[</span><span class="s1">&#39;otaz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">taz_idx_map</span><span class="p">)</span>
<span class="n">trips</span><span class="p">[</span><span class="s1">&#39;dtaz_ix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trips</span><span class="p">[</span><span class="s1">&#39;dtaz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">taz_idx_map</span><span class="p">)</span>
<span class="n">trips</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>orig_x</th>
      <th>orig_y</th>
      <th>dest_x</th>
      <th>dest_y</th>
      <th>otaz</th>
      <th>dtaz</th>
      <th>otaz_ix</th>
      <th>dtaz_ix</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>946907</td>
      <td>925689</td>
      <td>884665</td>
      <td>494832</td>
      <td>1129</td>
      <td>1122</td>
      <td>151</td>
      <td>144</td>
    </tr>
    <tr>
      <th>2</th>
      <td>952193</td>
      <td>945628</td>
      <td>892053</td>
      <td>478115</td>
      <td>1141</td>
      <td>1136</td>
      <td>163</td>
      <td>158</td>
    </tr>
    <tr>
      <th>3</th>
      <td>889200</td>
      <td>491106</td>
      <td>959298</td>
      <td>919813</td>
      <td>1132</td>
      <td>1144</td>
      <td>154</td>
      <td>166</td>
    </tr>
    <tr>
      <th>4</th>
      <td>877274</td>
      <td>476391</td>
      <td>947965</td>
      <td>925746</td>
      <td>1149</td>
      <td>1129</td>
      <td>171</td>
      <td>151</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The “data” within the OMX file can also be accessed as if it is a dictionary of numpy arrays. Each dictionary value isn’t actually an array, but it exposes a very similar interface, and can be used to read arrays directly into memory.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">skims</span><span class="p">[</span><span class="s2">&quot;AM_GP_TIME&quot;</span><span class="p">][:]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[ 1.992, 12.103,  8.116, ..., 11.371, 10.829, 11.093],
       [12.214,  2.516,  7.268, ..., 13.318, 14.36 ,  9.679],
       [ 8.258,  7.298,  2.491, ..., 11.785, 11.244, 11.507],
       ...,
       [11.287, 13.159, 11.56 , ...,  1.566,  3.523,  5.554],
       [10.714, 14.16 , 10.986, ...,  3.531,  1.216,  6.555],
       [11.168,  9.58 , 11.441, ...,  5.686,  6.727,  0.985]])
</pre></div></div>
</div>
<p>When we are building a discrete choice model for travel behavior, it is pretty common to need to attach individual values from the skims onto a table of data. For example, we have our table of trip observations, which contains a number of trips with the origin and destination zones coded. We can pass the columns of origin and destination zone indexes as the two dimensions of indexing, and get back a same-size set of values extracted from that array.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">skims</span><span class="p">[</span><span class="s2">&quot;AM_GP_TIME&quot;</span><span class="p">][</span><span class="n">trips</span><span class="o">.</span><span class="n">otaz_ix</span><span class="p">,</span> <span class="n">trips</span><span class="o">.</span><span class="n">dtaz_ix</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([15.411,  6.582,  6.038,  7.752])
</pre></div></div>
</div>
<p>We’ll probably want to attach many values from a single set of skims, and the <code class="docutils literal notranslate"><span class="pre">OMX</span></code> reader in Larch offers a convenience method to get all of them in a single command.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">skims_for_trips</span> <span class="o">=</span> <span class="n">skims</span><span class="o">.</span><span class="n">get_rc_dataframe</span><span class="p">(</span><span class="n">trips</span><span class="o">.</span><span class="n">otaz_ix</span><span class="p">,</span> <span class="n">trips</span><span class="o">.</span><span class="n">dtaz_ix</span><span class="p">)</span>
<span class="n">skims_for_trips</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AM_DAT_DIST</th>
      <th>AM_DAT_FFTIME</th>
      <th>AM_DAT_TIME</th>
      <th>AM_DAT_TOLLCOST</th>
      <th>AM_DAT_TOLLDIST</th>
      <th>AM_GP_DIST</th>
      <th>AM_GP_FFTIME</th>
      <th>AM_GP_TIME</th>
      <th>AM_S2NH_DIST</th>
      <th>AM_S2NH_FFTIME</th>
      <th>AM_S2NH_HOVDIST</th>
      <th>AM_S2NH_TIME</th>
      <th>AM_S2TH_DIST</th>
      <th>AM_S2TH_FFTIME</th>
      <th>AM_S2TH_HOVDIST</th>
      <th>AM_S2TH_TIME</th>
      <th>AM_S2TH_TOLLCOST</th>
      <th>AM_S2TH_TOLLDIST</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>7.384</td>
      <td>15.406</td>
      <td>15.411</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.384</td>
      <td>15.406</td>
      <td>15.411</td>
      <td>7.384</td>
      <td>15.406</td>
      <td>0.0</td>
      <td>15.411</td>
      <td>7.384</td>
      <td>15.406</td>
      <td>0.0</td>
      <td>15.411</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3.540</td>
      <td>6.478</td>
      <td>6.582</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3.540</td>
      <td>6.478</td>
      <td>6.582</td>
      <td>3.540</td>
      <td>6.478</td>
      <td>0.0</td>
      <td>6.582</td>
      <td>3.540</td>
      <td>6.478</td>
      <td>0.0</td>
      <td>6.582</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.245</td>
      <td>6.013</td>
      <td>6.038</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3.245</td>
      <td>6.013</td>
      <td>6.038</td>
      <td>3.245</td>
      <td>6.013</td>
      <td>0.0</td>
      <td>6.038</td>
      <td>3.245</td>
      <td>6.013</td>
      <td>0.0</td>
      <td>6.038</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.343</td>
      <td>7.732</td>
      <td>7.752</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4.343</td>
      <td>7.732</td>
      <td>7.752</td>
      <td>4.343</td>
      <td>7.732</td>
      <td>0.0</td>
      <td>7.752</td>
      <td>4.343</td>
      <td>7.732</td>
      <td>0.0</td>
      <td>7.752</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>If we want, we can concatenate the result with our original trips DataFrame, and have one large table to work.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trips</span><span class="p">,</span> <span class="n">skims_for_trips</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>orig_x</th>
      <th>orig_y</th>
      <th>dest_x</th>
      <th>dest_y</th>
      <th>otaz</th>
      <th>dtaz</th>
      <th>otaz_ix</th>
      <th>dtaz_ix</th>
      <th>AM_DAT_DIST</th>
      <th>AM_DAT_FFTIME</th>
      <th>...</th>
      <th>AM_S2NH_DIST</th>
      <th>AM_S2NH_FFTIME</th>
      <th>AM_S2NH_HOVDIST</th>
      <th>AM_S2NH_TIME</th>
      <th>AM_S2TH_DIST</th>
      <th>AM_S2TH_FFTIME</th>
      <th>AM_S2TH_HOVDIST</th>
      <th>AM_S2TH_TIME</th>
      <th>AM_S2TH_TOLLCOST</th>
      <th>AM_S2TH_TOLLDIST</th>
    </tr>
    <tr>
      <th>caseid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>946907</td>
      <td>925689</td>
      <td>884665</td>
      <td>494832</td>
      <td>1129</td>
      <td>1122</td>
      <td>151</td>
      <td>144</td>
      <td>7.384</td>
      <td>15.406</td>
      <td>...</td>
      <td>7.384</td>
      <td>15.406</td>
      <td>0.0</td>
      <td>15.411</td>
      <td>7.384</td>
      <td>15.406</td>
      <td>0.0</td>
      <td>15.411</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>952193</td>
      <td>945628</td>
      <td>892053</td>
      <td>478115</td>
      <td>1141</td>
      <td>1136</td>
      <td>163</td>
      <td>158</td>
      <td>3.540</td>
      <td>6.478</td>
      <td>...</td>
      <td>3.540</td>
      <td>6.478</td>
      <td>0.0</td>
      <td>6.582</td>
      <td>3.540</td>
      <td>6.478</td>
      <td>0.0</td>
      <td>6.582</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>889200</td>
      <td>491106</td>
      <td>959298</td>
      <td>919813</td>
      <td>1132</td>
      <td>1144</td>
      <td>154</td>
      <td>166</td>
      <td>3.245</td>
      <td>6.013</td>
      <td>...</td>
      <td>3.245</td>
      <td>6.013</td>
      <td>0.0</td>
      <td>6.038</td>
      <td>3.245</td>
      <td>6.013</td>
      <td>0.0</td>
      <td>6.038</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>877274</td>
      <td>476391</td>
      <td>947965</td>
      <td>925746</td>
      <td>1149</td>
      <td>1129</td>
      <td>171</td>
      <td>151</td>
      <td>4.343</td>
      <td>7.732</td>
      <td>...</td>
      <td>4.343</td>
      <td>7.732</td>
      <td>0.0</td>
      <td>7.752</td>
      <td>4.343</td>
      <td>7.732</td>
      <td>0.0</td>
      <td>7.752</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 26 columns</p>
</div></div>
</div>
</div>
</div>
<div class="section" id="Assembling-Data-for-Estimation">
<h2>Assembling Data for Estimation<a class="headerlink" href="#Assembling-Data-for-Estimation" title="Permalink to this headline">¶</a></h2>
<p>We’ve got a lot of different parts of our data laid out so far. All that’s left is to assemble all this data together, to get ready from model estimation. For estimation with Larch, there’s a <code class="docutils literal notranslate"><span class="pre">DataFrames</span></code> object designed to help with exactly this.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">larch</span> <span class="kn">import</span> <span class="n">DataFrames</span>
</pre></div>
</div>
</div>
<p>As the basic starting point for our <code class="docutils literal notranslate"><span class="pre">DataFrames</span></code>, we can use either an <code class="docutils literal notranslate"><span class="pre">idco</span></code> or <code class="docutils literal notranslate"><span class="pre">idca</span></code> format table. The simplest one is the <code class="docutils literal notranslate"><span class="pre">idco</span></code> format input, as there are very few requirements for this input type. All we need is a DataFrame with an integer-type index (a default RangeIndex meets this requirement).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">DataFrames</span><span class="p">(</span><span class="n">data_co</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
larch.DataFrames:  (not computation-ready)
  n_cases: 4
  n_alts: 0
  data_ca: &lt;not populated&gt;
  data_co:
    - Income   (4 non-null int64)
    - CarTime  (4 non-null int64)
    - CarCost  (4 non-null int64)
    - BusTime  (4 non-null int64)
    - BusCost  (4 non-null int64)
    - WalkTime (4 non-null int64)
    - Chosen   (4 non-null object)
</pre></div></div>
</div>
<p>If we just create our DataFrames with an <code class="docutils literal notranslate"><span class="pre">idco</span></code> table and nothing else, as we do above, it will work fine, although the resulting DataFrames object will be missing a bunch of relevant information, like how many alternatives are represented, what their names are, which alternative were available and which alternative was chosen in each case. We can add this information as extra arguments for the DataFrames constructor.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">DataFrames</span><span class="p">(</span>
    <span class="n">data_co</span><span class="p">,</span>
    <span class="n">ch</span><span class="o">=</span><span class="s1">&#39;Chosen&#39;</span><span class="p">,</span>
    <span class="n">alt_codes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
    <span class="n">alt_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Car&#39;</span><span class="p">,</span><span class="s1">&#39;Bus&#39;</span><span class="p">,</span><span class="s1">&#39;Walk&#39;</span><span class="p">],</span>
    <span class="n">av</span><span class="o">=</span><span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;WalkTime &gt; 0&#39;</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
larch.DataFrames:  (not computation-ready)
  n_cases: 4
  n_alts: 3
  data_ca: &lt;not populated&gt;
  data_co:
    - Income   (4 non-null int64)
    - CarTime  (4 non-null int64)
    - CarCost  (4 non-null int64)
    - BusTime  (4 non-null int64)
    - BusCost  (4 non-null int64)
    - WalkTime (4 non-null int64)
    - Chosen   (4 non-null object)
  data_av: &lt;populated&gt;
  data_ch: Chosen
</pre></div></div>
</div>
<p>Larch also allows us to start with <code class="docutils literal notranslate"><span class="pre">idca</span></code> data instead. However, there are some more particular requirements on how the <code class="docutils literal notranslate"><span class="pre">idca</span></code> data should be formatted before passing it to the DataFrames constructor. Instead of requiring a integer-type index, the <code class="docutils literal notranslate"><span class="pre">idca</span></code> data must have a two-level pandas MultiIndex, and the first level need to be an integer type, giving caseids. The second level gives alterative ids, and it can be a non-integer set of categorical values (or it can be integer code numbers).
If we ignore this, and just put our single-level index DataFrame into the contructor, Larch will assume it’s actually <code class="docutils literal notranslate"><span class="pre">idco</span></code> data, as we see below where there appears to be 11 cases.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">DataFrames</span><span class="p">(</span><span class="n">data_ca</span><span class="p">)</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
larch.DataFrames:  (not computation-ready)
  n_cases: 11
  n_alts: 0
  data_ca: &lt;not populated&gt;
  data_co:
    - caseid (11 non-null int64)
    - altid  (11 non-null object)
    - Income (11 non-null int64)
    - Time   (11 non-null int64)
    - Cost   (11 non-null int64)
    - Chosen (11 non-null int64)
</pre></div></div>
</div>
<p>If we set our index correctly first, we’ll get a better result, which shows 11 rows in the data_ce dataframe, but only 4 cases total.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">DataFrames</span><span class="p">(</span><span class="n">data_ca</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;caseid&#39;</span><span class="p">,</span><span class="s1">&#39;altid&#39;</span><span class="p">]))</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
larch.DataFrames:  (not computation-ready)
  n_cases: 4
  n_alts: 3
  data_ce: 11 rows
    - Income (11 non-null int64)
    - Time   (11 non-null int64)
    - Cost   (11 non-null int64)
    - Chosen (11 non-null int64)
  data_co: &lt;not populated&gt;
  data_av: &lt;populated&gt;
</pre></div></div>
</div>
<p>Here, Larch has detected the alternative names given in the second level of the index, and makes them available later.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dfs</span><span class="o">.</span><span class="n">alternative_names</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;Bus&#39;, &#39;Car&#39;, &#39;Walk&#39;]
</pre></div></div>
</div>
<p>Also, you might note that Larch has automatically detected that the provided dataframe is in sparse-format and stored it not as <code class="docutils literal notranslate"><span class="pre">data_ca</span></code> but instead as <code class="docutils literal notranslate"><span class="pre">data_ce</span></code>. If we use actual dense-format inputs, we’ll get a DataFrames object that uses the dense <code class="docutils literal notranslate"><span class="pre">data_ca</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">DataFrames</span><span class="p">(</span><span class="n">forced_ca</span><span class="p">)</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
larch.DataFrames:  (not computation-ready)
  n_cases: 4
  n_alts: 3
  data_ca:
    - Chosen (12 non-null float64)
    - Cost   (8 non-null object)
    - Income (12 non-null int64)
    - Time   (12 non-null object)
  data_co: &lt;not populated&gt;
</pre></div></div>
</div>
<p>Although Larch can auto-detect the alternatives when loading data in <code class="docutils literal notranslate"><span class="pre">idca</span></code> format, it can’t auto-detect which column contains the “choice” data. And when we provide dense-format inputs, Larch also can’t infer availablity without help. Just as we provided some helpful hints to fill in the gaps for the <code class="docutils literal notranslate"><span class="pre">idco</span></code> input, we can do so for the <code class="docutils literal notranslate"><span class="pre">idca</span></code> input as well.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">DataFrames</span><span class="p">(</span><span class="n">forced_ca</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="s1">&#39;Chosen&#39;</span><span class="p">,</span> <span class="n">av</span><span class="o">=</span><span class="s1">&#39;Time&gt;0&#39;</span><span class="p">)</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
larch.DataFrames:  (not computation-ready)
  n_cases: 4
  n_alts: 3
  data_ca:
    - Chosen (12 non-null float64)
    - Cost   (8 non-null object)
    - Income (12 non-null int64)
    - Time   (12 non-null object)
  data_co: &lt;not populated&gt;
  data_av: Time&gt;0
  data_ch: Chosen
</pre></div></div>
</div>
<p>When loading <code class="docutils literal notranslate"><span class="pre">idca</span></code> data, we can opt to let Larch automatically identify data columns that do not vary within observations (and therefore can be represented more succinctly as <code class="docutils literal notranslate"><span class="pre">idco</span></code> data), and “crack” the data into its contituent <code class="docutils literal notranslate"><span class="pre">idca</span></code> and <code class="docutils literal notranslate"><span class="pre">idco</span></code> parts. For efficiency reasons, only numeric columns are processed in this manner, so if we want it to work as expected we need to ensure all our numeric data is actually stored in numeric dtypes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">DataFrames</span><span class="p">(</span><span class="n">forced_ca</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">ch</span><span class="o">=</span><span class="s1">&#39;Chosen&#39;</span><span class="p">,</span> <span class="n">av</span><span class="o">=</span><span class="s1">&#39;Time&gt;0&#39;</span><span class="p">,</span> <span class="n">crack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dfs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
larch.DataFrames:
  n_cases: 4
  n_alts: 3
  data_ca:
    - Chosen (12 non-null float64)
    - Cost   (8 non-null float64)
    - Time   (12 non-null float64)
  data_co:
    - Income (4 non-null float64)
  data_av: Time&gt;0
  data_ch: Chosen
</pre></div></div>
</div>
<p>If you’ve noticed the “not computation-ready” indicators on the various output above, you might also have noticed that this last DataFrames is the first that doesn’t bear that mark. These flags are a result of one or more data columns that are not presently stored in double precision or “float64” format, and for this last DataFrames we forced all the data into the correct format. It’s not a big problem if we don’t do so, as Larch will automatically convert data into this format when you try to
estimate a model.</p>
</div>
<div class="section" id="Data-Subsets">
<h2>Data Subsets<a class="headerlink" href="#Data-Subsets" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, you’ll assemble a full DataFrames based on a “complete” dataset, but you’ll only want to work on a discrete choice model for a subset of the data. This can happen, for example, if you build the DataFrames off the “trips” table from a household travel survey, but you want to estimate a mode choice model only for home-based work trips.</p>
<p>When the query filter for the dataset you want can be expressed as a function of the <code class="docutils literal notranslate"><span class="pre">data_co</span></code> in a Dataframes, you can use the <code class="docutils literal notranslate"><span class="pre">selector_co</span></code> method to make a new DataFrames that is the correct subset of all your data – <code class="docutils literal notranslate"><span class="pre">idca</span></code>, choice, availability, and weighting data are also sliced along with the <code class="docutils literal notranslate"><span class="pre">idco</span></code> data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dfs1</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">selector_co</span><span class="p">(</span><span class="s2">&quot;Income &gt; 35_000&quot;</span><span class="p">)</span>
<span class="n">dfs1</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
larch.DataFrames:
  n_cases: 2
  n_alts: 3
  data_ca:
    - Chosen (6 non-null float64)
    - Cost   (4 non-null float64)
    - Time   (6 non-null float64)
  data_co:
    - Income (2 non-null float64)
  data_av: &lt;populated&gt;
  data_ch: &lt;populated&gt;
</pre></div></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="004-mtc-modechoice-practical.html" class="btn btn-neutral float-right" title="Practical Mode Choice" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="002-estimating-parameters.html" class="btn btn-neutral float-left" title="Estimating Model Parameters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>