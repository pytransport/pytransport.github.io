

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Exampville Destination Choice &mdash; Python for Transportation 1.1.2, June 2022 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Exercises" href="../exercises/_index.html" />
    <link rel="prev" title="Exampville Mode Choice Logsums" href="102_exville_mc_logsums.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Python for Transportation
          

          
          </a>

          
            
            
              <div class="version">
                1.1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../starting/_index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic-python/_index.html">Python Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tabular-analysis/_index.html">Tabular Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/_index.html">Data Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geographic-analysis/_index.html">Geographic Analysis</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_index.html">Discrete Choice Modeling</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="001-fundamentals.html">Discrete Choice Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="002-estimating-parameters.html">Estimating Model Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="003-data-for-discrete-choice.html">Data for Discrete Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="004-mtc-modechoice-practical.html">Practical Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="005-nested-logit.html">Nested Logit</a></li>
<li class="toctree-l2"><a class="reference internal" href="101_exville_mode_choice.html">Exampville Mode Choice</a></li>
<li class="toctree-l2"><a class="reference internal" href="102_exville_mc_logsums.html">Exampville Mode Choice Logsums</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Exampville Destination Choice</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Data-Preparation">Data Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Model-Definition">Model Definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Model-Estimation">Model Estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Model-Visualization">Model Visualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Coincidence-Ratio">Coincidence Ratio</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Other-Distributions">Other Distributions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Save-and-Report-Model">Save and Report Model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/_index.html">Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/example-data.html">Tutorial Data Files</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Python for Transportation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="_index.html">Discrete Choice Modeling</a> &raquo;</li>
        
      <li>Exampville Destination Choice</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/course-content/choice-modeling/103_exville_dest.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Exampville-Destination-Choice">
<h1>Exampville Destination Choice<a class="headerlink" href="#Exampville-Destination-Choice" title="Permalink to this headline">¶</a></h1>
<p>In this notebook, we will walk through the estimation of a tour destination choice model for Exampville, an entirely fictional town built for the express purpose of demostrating the use of discrete choice modeling tools for transportation planning.</p>
<p>This example will assume the reader is familiar with the mathematical basics of destination choice modeling generally, and will focus on the technical aspects of estimating the parameters of a destination choice model in Python using Larch.</p>
<p>If you have not yet estimated parameters of a mode choice model or generated logsums from that model, you should go back and review those sections before you begin this one.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">larch</span><span class="o">,</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">pandas</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">larch</span> <span class="kn">import</span> <span class="n">P</span><span class="p">,</span> <span class="n">X</span>
</pre></div>
</div>
</div>
<div class="section" id="Data-Preparation">
<h2>Data Preparation<a class="headerlink" href="#Data-Preparation" title="Permalink to this headline">¶</a></h2>
<p>To begin, we will re-load the data files from our tour mode choice example.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">larch.exampville</span>

<span class="n">hh</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span> <span class="n">larch</span><span class="o">.</span><span class="n">exampville</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">hh</span> <span class="p">)</span>
<span class="n">pp</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span> <span class="n">larch</span><span class="o">.</span><span class="n">exampville</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">person</span> <span class="p">)</span>
<span class="n">tour</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span> <span class="n">larch</span><span class="o">.</span><span class="n">exampville</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">tour</span> <span class="p">)</span>
<span class="n">skims</span> <span class="o">=</span> <span class="n">larch</span><span class="o">.</span><span class="n">OMX</span><span class="p">(</span> <span class="n">larch</span><span class="o">.</span><span class="n">exampville</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">skims</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<p>We’ll also load an employment file. This file contains employment data by TAZ. The TAZ’s will be the choices in the destination choice model, and the employment data will allow us to characterize the number of opportunities in each TAZ.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">emp</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">larch</span><span class="o">.</span><span class="n">exampville</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">employment</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;TAZ&#39;</span><span class="p">)</span>
<span class="n">emp</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 40 entries, 1 to 40
Data columns (total 3 columns):
 #   Column         Non-Null Count  Dtype
---  ------         --------------  -----
 0   NONRETAIL_EMP  40 non-null     int64
 1   RETAIL_EMP     40 non-null     int64
 2   TOTAL_EMP      40 non-null     int64
dtypes: int64(3)
memory usage: 1.2 KB
</pre></div></div>
</div>
<p>We’ll also load the saved logsums from the mode choice estimation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logsums</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;/tmp/logsums.pkl.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We’ll replicate the pre-processing used in the mode choice estimation, to merge the household and person characteristics into the tours data, add the index values for the home TAZ’s, filter to include only work tours, and merge with the level of service skims. (If this pre-processing was computationally expensive, it would probably have been better to save the results to disk and reload them as needed, but for this model these commands will run almost instantaneously.)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">co</span> <span class="o">=</span> <span class="n">tour</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">hh</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;HHID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;HHID&#39;</span><span class="p">,</span> <span class="s1">&#39;PERSONID&#39;</span><span class="p">))</span>
<span class="n">co</span><span class="p">[</span><span class="s2">&quot;HOMETAZi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">co</span><span class="p">[</span><span class="s2">&quot;HOMETAZ&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">co</span><span class="p">[</span><span class="s2">&quot;DTAZi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">co</span><span class="p">[</span><span class="s2">&quot;DTAZ&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">co</span> <span class="o">=</span> <span class="n">co</span><span class="p">[</span><span class="n">co</span><span class="o">.</span><span class="n">TOURPURP</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">co</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CASE_ID&#39;</span>
</pre></div>
</div>
</div>
<p>For this destination choice model, we’ll want to use the mode choice logsums we calculated previously, and we’ll use these values as data. The alternatives in the destinations model are much more regular than in the mode choice model – the utility function for each destination will have a common form – we’ll use <code class="docutils literal notranslate"><span class="pre">idca</span></code> format to make data management simpler. This format maintains a data array in three dimensions instead of two: cases, alternatives, and variables. We can still use a
pandas.DataFrame to hold this data, but we’ll use a <code class="docutils literal notranslate"><span class="pre">MultiIndex</span></code> for one of the typical dimensions.</p>
<p>We already have one <code class="docutils literal notranslate"><span class="pre">idca</span></code> format variable: the logsums we loaded above. For a destination choice model, we’ll often also want to use distance –specifically, the distance from the known origin zone to each possible destination zones. We can create a distance variable as an array, selecting for each case in the <code class="docutils literal notranslate"><span class="pre">co</span></code> data a row from the ‘AUTO_DIST’ array that matches the correct origin zone (by index number). Note that we first load the skim array into memory using <code class="docutils literal notranslate"><span class="pre">[:]</span></code> and then select the
rows, to overcome a technical limitation of the PyTables library (which underpins the open matrix format) that prevents us from reading the final array directly from the file on disk.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">distance</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">skims</span><span class="o">.</span><span class="n">AUTO_DIST</span><span class="p">[:][</span><span class="n">co</span><span class="p">[</span><span class="s2">&quot;HOMETAZi&quot;</span><span class="p">],</span> <span class="p">:],</span>
    <span class="n">index</span><span class="o">=</span><span class="n">co</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="n">skims</span><span class="o">.</span><span class="n">TAZ_ID</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">distance</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CASE_ID  TAZ_ID
0        1         8.286090
         2         8.256698
         3         2.928829
         4         5.502758
         5         5.882862
                     ...
20736    36        5.217099
         37        1.832760
         38        2.816438
         39        4.940639
         40        3.047736
Length: 302560, dtype: float64
</pre></div></div>
</div>
<p>The distance and logsum arrays are both currently formatted as single variables stored in two-dimensional format (cases by alternatives) but to concatenate them together, we can use the <code class="docutils literal notranslate"><span class="pre">unstack</span></code> command to convert each into a one-dimensional array. We’ll also use the <code class="docutils literal notranslate"><span class="pre">rename</span></code> command to ensure that each one-dimensional array is named appropriately, so that when they are concatenate the result will include the names of the variables.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">distance</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">),</span>
    <span class="n">logsums</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;logsum&quot;</span><span class="p">),</span>
<span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we have our two variables in the correct format:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>distance</th>
      <th>logsum</th>
    </tr>
    <tr>
      <th></th>
      <th>TAZ_ID</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>1</th>
      <td>8.286090</td>
      <td>-2.935609</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.256698</td>
      <td>-2.660434</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.928829</td>
      <td>-1.745653</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.502758</td>
      <td>-2.229279</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.882862</td>
      <td>-2.403116</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We’ll also need to join employment data to the <code class="docutils literal notranslate"><span class="pre">ca</span></code> DataFrame. This data has unique values only by alternative and not by caseid, so there are only 40 unique rows.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">emp</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 40 entries, 1 to 40
Data columns (total 3 columns):
 #   Column         Non-Null Count  Dtype
---  ------         --------------  -----
 0   NONRETAIL_EMP  40 non-null     int64
 1   RETAIL_EMP     40 non-null     int64
 2   TOTAL_EMP      40 non-null     int64
dtypes: int64(3)
memory usage: 1.2 KB
</pre></div></div>
</div>
<p>But to make this work with the computational arrays required for Larch, we’ll need to join this to the other idca data, like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">emp</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;TAZ_ID&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skims</span><span class="o">.</span><span class="n">TAZ_AREA_TYPE</span><span class="p">[:]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;URB&#39;, b&#39;URB&#39;, b&#39;SUB&#39;, b&#39;URB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;,
       b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;,
       b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;,
       b&#39;URB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;URB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;,
       b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;URB&#39;, b&#39;CBD&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;, b&#39;SUB&#39;],
      dtype=&#39;|S3&#39;)
</pre></div></div>
</div>
<p>We can also extract an ‘Area Type’ variable from the skims, and attach that as well:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">area_type</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">skims</span><span class="o">.</span><span class="n">TAZ_AREA_TYPE</span><span class="p">[:],</span>
    <span class="n">index</span><span class="o">=</span><span class="n">skims</span><span class="o">.</span><span class="n">TAZ_ID</span><span class="p">[:],</span>
    <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;TAZ_AREA_TYPE&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">area_type</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1     b&#39;SUB&#39;
2     b&#39;SUB&#39;
3     b&#39;URB&#39;
4     b&#39;URB&#39;
5     b&#39;SUB&#39;
6     b&#39;URB&#39;
7     b&#39;SUB&#39;
8     b&#39;SUB&#39;
9     b&#39;SUB&#39;
10    b&#39;SUB&#39;
11    b&#39;SUB&#39;
12    b&#39;SUB&#39;
13    b&#39;SUB&#39;
14    b&#39;SUB&#39;
15    b&#39;SUB&#39;
16    b&#39;SUB&#39;
17    b&#39;SUB&#39;
18    b&#39;SUB&#39;
19    b&#39;SUB&#39;
20    b&#39;SUB&#39;
21    b&#39;SUB&#39;
22    b&#39;SUB&#39;
23    b&#39;SUB&#39;
24    b&#39;SUB&#39;
25    b&#39;URB&#39;
26    b&#39;SUB&#39;
27    b&#39;SUB&#39;
28    b&#39;URB&#39;
29    b&#39;SUB&#39;
30    b&#39;SUB&#39;
31    b&#39;SUB&#39;
32    b&#39;SUB&#39;
33    b&#39;SUB&#39;
34    b&#39;SUB&#39;
35    b&#39;URB&#39;
36    b&#39;CBD&#39;
37    b&#39;SUB&#39;
38    b&#39;SUB&#39;
39    b&#39;SUB&#39;
40    b&#39;SUB&#39;
Name: TAZ_AREA_TYPE, dtype: category
Categories (3, object): [b&#39;CBD&#39;, b&#39;SUB&#39;, b&#39;URB&#39;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">area_type</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;TAZ_ID&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>distance</th>
      <th>logsum</th>
      <th>NONRETAIL_EMP</th>
      <th>RETAIL_EMP</th>
      <th>TOTAL_EMP</th>
      <th>TAZ_AREA_TYPE</th>
    </tr>
    <tr>
      <th></th>
      <th>TAZ_ID</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>1</th>
      <td>8.286090</td>
      <td>-2.935609</td>
      <td>118</td>
      <td>340</td>
      <td>458</td>
      <td>b'SUB'</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.256698</td>
      <td>-2.660434</td>
      <td>91</td>
      <td>0</td>
      <td>91</td>
      <td>b'SUB'</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.928829</td>
      <td>-1.745653</td>
      <td>197</td>
      <td>2</td>
      <td>199</td>
      <td>b'URB'</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.502758</td>
      <td>-2.229279</td>
      <td>277</td>
      <td>8</td>
      <td>285</td>
      <td>b'URB'</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.882862</td>
      <td>-2.403116</td>
      <td>44</td>
      <td>13</td>
      <td>57</td>
      <td>b'SUB'</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Then we bundle the raw data into the <code class="docutils literal notranslate"><span class="pre">larch.DataFrames</span></code> structure, as we did for estimation, and attach this structure to the model as its <code class="docutils literal notranslate"><span class="pre">dataservice</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">larch</span><span class="o">.</span><span class="n">DataFrames</span><span class="p">(</span>
    <span class="n">co</span><span class="o">=</span><span class="n">co</span><span class="p">,</span>
    <span class="n">ca</span><span class="o">=</span><span class="n">ca</span><span class="p">,</span>
    <span class="n">alt_codes</span><span class="o">=</span><span class="n">skims</span><span class="o">.</span><span class="n">TAZ_ID</span><span class="p">,</span>
    <span class="n">alt_names</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;TAZ</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skims</span><span class="o">.</span><span class="n">TAZ_ID</span><span class="p">],</span>
    <span class="n">ch_name</span><span class="o">=</span><span class="s1">&#39;DTAZ&#39;</span><span class="p">,</span>
    <span class="n">av</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
larch.DataFrames:  (not computation-ready)
  n_cases: 7564
  n_alts: 40
  data_ca:
    - distance      (302560 non-null float64)
    - logsum        (302560 non-null float64)
    - NONRETAIL_EMP (302560 non-null int64)
    - RETAIL_EMP    (302560 non-null int64)
    - TOTAL_EMP     (302560 non-null int64)
    - TAZ_AREA_TYPE (302560 non-null category)
  data_co:
    - TOURID        (7564 non-null int64)
    - HHID          (7564 non-null int64)
    - PERSONID      (7564 non-null int64)
    - DTAZ          (7564 non-null int64)
    - TOURMODE      (7564 non-null int64)
    - TOURPURP      (7564 non-null int64)
    - N_STOPS       (7564 non-null int64)
    - N_TRIPS_x     (7564 non-null int64)
    - N_TRIPS_HBW_x (7564 non-null int64)
    - N_TRIPS_HBO_x (7564 non-null int64)
    - N_TRIPS_NHB_x (7564 non-null int64)
    - X             (7564 non-null float64)
    - Y             (7564 non-null float64)
    - INCOME        (7564 non-null float64)
    - N_VEHICLES    (7564 non-null int64)
    - HHSIZE        (7564 non-null int64)
    - geometry      (7564 non-null object)
    - HOMETAZ       (7564 non-null int64)
    - N_TRIPS_y     (7564 non-null int64)
    - N_TRIPS_HBW_y (7564 non-null int64)
    - N_TRIPS_HBO_y (7564 non-null int64)
    - N_TRIPS_NHB_y (7564 non-null int64)
    - N_WORKERS     (7564 non-null int64)
    - HHIDX         (7564 non-null int64)
    - AGE           (7564 non-null int64)
    - WORKS         (7564 non-null int64)
    - N_WORK_TOURS  (7564 non-null int64)
    - N_OTHER_TOURS (7564 non-null int64)
    - N_TOURS       (7564 non-null int64)
    - N_TRIPS       (7564 non-null int64)
    - N_TRIPS_HBW   (7564 non-null int64)
    - N_TRIPS_HBO   (7564 non-null int64)
    - N_TRIPS_NHB   (7564 non-null int64)
    - HOMETAZi      (7564 non-null int64)
    - DTAZi         (7564 non-null int64)
  data_av: &lt;populated&gt;
  data_ch: DTAZ
</pre></div></div>
</div>
</div>
<div class="section" id="Model-Definition">
<h2>Model Definition<a class="headerlink" href="#Model-Definition" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">larch</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">dataservice</span><span class="o">=</span><span class="n">dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Destination choice models are premised on the theory that each trip or tour has a particular destination to which it is attracted, and each travel zone represents not one individual alternative, but rather a number of similar alternatives grouped together. Thus the utility function in a destination choice model typically is comprised of two components: a qualitative component (i.e., how good are the alternatives in a zone) and a quantitative component (i.e., how many discrete alternatives are in
a zone). The mathematical form of the utility function for the zone is</p>
<div class="math notranslate nohighlight">
\[\sum_i{\beta_i}X_i + \theta\log\left(\sum_j{\exp(\gamma_j)}Z_j\right)\]</div>
<p>The quantitative component of this utility function is written for Larch in a linear-in-parameters format similarly to that for the typical utility function, but assigned to the <code class="docutils literal notranslate"><span class="pre">quantity_ca</span></code> attribute instead of <code class="docutils literal notranslate"><span class="pre">utility_ca</span></code>. Also, the exponentiation of the <span class="math notranslate nohighlight">\(\gamma\)</span> parameters is implied by using <code class="docutils literal notranslate"><span class="pre">quantity_ca</span></code>. Note that the quantitative term is in theory always applied only to the alternatives themselves and not alone to attributes of the decision maker, so the <code class="docutils literal notranslate"><span class="pre">quantity_co</span></code>
attribute is not implemented and cannot be used.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">quantity_ca</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">+</span> <span class="n">P</span><span class="o">.</span><span class="n">EmpRetail_HighInc</span> <span class="o">*</span> <span class="n">X</span><span class="p">(</span><span class="s1">&#39;RETAIL_EMP * (INCOME&gt;50000)&#39;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">P</span><span class="o">.</span><span class="n">EmpNonRetail_HighInc</span> <span class="o">*</span> <span class="n">X</span><span class="p">(</span><span class="s1">&#39;NONRETAIL_EMP&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">X</span><span class="p">(</span><span class="s2">&quot;INCOME&gt;50000&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">P</span><span class="o">.</span><span class="n">EmpRetail_LowInc</span> <span class="o">*</span> <span class="n">X</span><span class="p">(</span><span class="s1">&#39;RETAIL_EMP&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">X</span><span class="p">(</span><span class="s2">&quot;INCOME&lt;=50000&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">P</span><span class="o">.</span><span class="n">EmpNonRetail_LowInc</span> <span class="o">*</span> <span class="n">X</span><span class="p">(</span><span class="s1">&#39;NONRETAIL_EMP&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">X</span><span class="p">(</span><span class="s2">&quot;INCOME&lt;=50000&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>The parameter <span class="math notranslate nohighlight">\(\theta\)</span> is a coefficient on the entire log-of-quantity term, and can be defined by assigning a parameter name to the <code class="docutils literal notranslate"><span class="pre">quantity_scale</span></code> attribute.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#m.quantity_scale = P.Theta</span>
</pre></div>
</div>
</div>
<p>The qualitative component of utility can be given in the same manner as any other discrete choice model in Larch.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">utility_ca</span> <span class="o">=</span> <span class="p">(</span>
    <span class="o">+</span> <span class="n">P</span><span class="o">.</span><span class="n">logsum</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">logsum</span>
    <span class="o">+</span> <span class="n">P</span><span class="o">.</span><span class="n">distance</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">distance</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>For this structure, we know the model will be overspecified if the parameter in the quantitative portion of utility are all estimated, in a manner similar to the overspecification if alternative specific constants are all estimated. To prevent this problem, we can lock parameters to particular values as needed using the <code class="docutils literal notranslate"><span class="pre">lock_values</span></code> method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">lock_values</span><span class="p">(</span>
    <span class="n">EmpRetail_HighInc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">EmpRetail_LowInc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then let’s prepare this data for estimation. Even though the data is already in memory, the <code class="docutils literal notranslate"><span class="pre">load_data</span></code> method is used to pre-process the data, extracting the required values, pre-computing the values of fixed expressions, and assembling the results into contiguous arrays suitable for computing the log likelihood values efficiently.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
req_data does not request {choice_ca,choice_co,choice_co_code} but choice is set and being provided
req_data does not request avail_ca or avail_co but it is set and being provided
</pre></div></div>
</div>
</div>
<div class="section" id="Model-Estimation">
<h2>Model Estimation<a class="headerlink" href="#Model-Estimation" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">maximize_loglike</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<h3>Iteration 009 [Optimization terminated successfully] </h3></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<p>Best LL = -25287.5271358175</p></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>value</th>
      <th>initvalue</th>
      <th>nullvalue</th>
      <th>minimum</th>
      <th>maximum</th>
      <th>holdfast</th>
      <th>note</th>
      <th>best</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>EmpNonRetail_HighInc</th>
      <td>0.854336</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-inf</td>
      <td>inf</td>
      <td>0</td>
      <td></td>
      <td>0.854336</td>
    </tr>
    <tr>
      <th>EmpNonRetail_LowInc</th>
      <td>-0.756049</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-inf</td>
      <td>inf</td>
      <td>0</td>
      <td></td>
      <td>-0.756049</td>
    </tr>
    <tr>
      <th>EmpRetail_HighInc</th>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1</td>
      <td></td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>EmpRetail_LowInc</th>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1</td>
      <td></td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>distance</th>
      <td>-0.059396</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-inf</td>
      <td>inf</td>
      <td>0</td>
      <td></td>
      <td>-0.059396</td>
    </tr>
    <tr>
      <th>logsum</th>
      <td>1.081704</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-inf</td>
      <td>inf</td>
      <td>0</td>
      <td></td>
      <td>1.081704</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/jeffnewman/opt/anaconda3/envs/tt/lib/python3.9/site-packages/larch/model/optimization.py:306: UserWarning: slsqp may not play nicely with unbounded parameters
if you get poor results, consider setting global bounds with model.set_cap()
  warnings.warn( # infinite bounds # )
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><table style="margin-top:1px;"><tr><th>key</th><th style="text-align:left;">value</th></tr><tr><td>x</td><td style="text-align:left;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>EmpNonRetail_HighInc</th>
      <td>0.854336</td>
    </tr>
    <tr>
      <th>EmpNonRetail_LowInc</th>
      <td>-0.756049</td>
    </tr>
    <tr>
      <th>EmpRetail_HighInc</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>EmpRetail_LowInc</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>distance</th>
      <td>-0.059396</td>
    </tr>
    <tr>
      <th>logsum</th>
      <td>1.081704</td>
    </tr>
  </tbody>
</table></td></tr><tr><td>loglike</td><td style="text-align:left;">-25287.5271358175</td></tr><tr><td>d_loglike</td><td style="text-align:left;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>EmpNonRetail_HighInc</th>
      <td>0.003384</td>
    </tr>
    <tr>
      <th>EmpNonRetail_LowInc</th>
      <td>0.006065</td>
    </tr>
    <tr>
      <th>EmpRetail_HighInc</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>EmpRetail_LowInc</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>distance</th>
      <td>0.003929</td>
    </tr>
    <tr>
      <th>logsum</th>
      <td>-0.002454</td>
    </tr>
  </tbody>
</table></td></tr><tr><td>nit</td><td style="text-align:left;">9</td></tr><tr><td>nfev</td><td style="text-align:left;">24</td></tr><tr><td>njev</td><td style="text-align:left;">9</td></tr><tr><td>status</td><td style="text-align:left;">0</td></tr><tr><td>message</td><td style="text-align:left;">'Optimization terminated successfully'</td></tr><tr><td>success</td><td style="text-align:left;">True</td></tr><tr><td>elapsed_time</td><td style="text-align:left;">0:00:02.543280</td></tr><tr><td>method</td><td style="text-align:left;">'slsqp'</td></tr><tr><td>n_cases</td><td style="text-align:left;">7564</td></tr><tr><td>iteration_number</td><td style="text-align:left;">9</td></tr><tr><td>logloss</td><td style="text-align:left;">3.343142138526904</td></tr></table></div></div>
</div>
<p>After we find the best fitting parameters, we can compute some variance-covariance statistics, incuding standard errors of the estimates and t statistics, using <code class="docutils literal notranslate"><span class="pre">calculate_parameter_covariance</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">calculate_parameter_covariance</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Then we can review the results in a variety of report tables.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">parameter_summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style  type="text/css" >
    #T_593a7_ th {
          vertical-align: top;
          text-align: left;
    }    #T_593a7_ td {
          vertical-align: top;
          text-align: left;
    }#T_593a7_row0_col0,#T_593a7_row0_col1,#T_593a7_row0_col2,#T_593a7_row0_col3,#T_593a7_row0_col4,#T_593a7_row1_col0,#T_593a7_row1_col1,#T_593a7_row1_col2,#T_593a7_row1_col3,#T_593a7_row1_col4,#T_593a7_row2_col0,#T_593a7_row2_col1,#T_593a7_row2_col2,#T_593a7_row2_col3,#T_593a7_row2_col4,#T_593a7_row3_col0,#T_593a7_row3_col1,#T_593a7_row3_col2,#T_593a7_row3_col3,#T_593a7_row3_col4,#T_593a7_row4_col0,#T_593a7_row4_col1,#T_593a7_row4_col2,#T_593a7_row4_col3,#T_593a7_row4_col4,#T_593a7_row5_col0,#T_593a7_row5_col1,#T_593a7_row5_col2,#T_593a7_row5_col3,#T_593a7_row5_col4{
            font-family: monospace;
        }</style><table id="T_593a7_" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >Value</th>        <th class="col_heading level0 col1" >Std Err</th>        <th class="col_heading level0 col2" >t Stat</th>        <th class="col_heading level0 col3" >Signif</th>        <th class="col_heading level0 col4" >Null Value</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_593a7_level0_row0" class="row_heading level0 row0" >EmpNonRetail_HighInc</th>
                        <td id="T_593a7_row0_col0" class="data row0 col0" > 0.854</td>
                        <td id="T_593a7_row0_col1" class="data row0 col1" > 0.137</td>
                        <td id="T_593a7_row0_col2" class="data row0 col2" > 6.22</td>
                        <td id="T_593a7_row0_col3" class="data row0 col3" >***</td>
                        <td id="T_593a7_row0_col4" class="data row0 col4" > 0.00</td>
            </tr>
            <tr>
                        <th id="T_593a7_level0_row1" class="row_heading level0 row1" >EmpNonRetail_LowInc</th>
                        <td id="T_593a7_row1_col0" class="data row1 col0" >-0.756</td>
                        <td id="T_593a7_row1_col1" class="data row1 col1" > 0.0615</td>
                        <td id="T_593a7_row1_col2" class="data row1 col2" >-12.30</td>
                        <td id="T_593a7_row1_col3" class="data row1 col3" >***</td>
                        <td id="T_593a7_row1_col4" class="data row1 col4" > 0.00</td>
            </tr>
            <tr>
                        <th id="T_593a7_level0_row2" class="row_heading level0 row2" >EmpRetail_HighInc</th>
                        <td id="T_593a7_row2_col0" class="data row2 col0" > 0.00</td>
                        <td id="T_593a7_row2_col1" class="data row2 col1" > 0.00</td>
                        <td id="T_593a7_row2_col2" class="data row2 col2" > NA</td>
                        <td id="T_593a7_row2_col3" class="data row2 col3" ></td>
                        <td id="T_593a7_row2_col4" class="data row2 col4" > 0.00</td>
            </tr>
            <tr>
                        <th id="T_593a7_level0_row3" class="row_heading level0 row3" >EmpRetail_LowInc</th>
                        <td id="T_593a7_row3_col0" class="data row3 col0" > 0.00</td>
                        <td id="T_593a7_row3_col1" class="data row3 col1" > 0.00</td>
                        <td id="T_593a7_row3_col2" class="data row3 col2" > NA</td>
                        <td id="T_593a7_row3_col3" class="data row3 col3" ></td>
                        <td id="T_593a7_row3_col4" class="data row3 col4" > 0.00</td>
            </tr>
            <tr>
                        <th id="T_593a7_level0_row4" class="row_heading level0 row4" >distance</th>
                        <td id="T_593a7_row4_col0" class="data row4 col0" >-0.0594</td>
                        <td id="T_593a7_row4_col1" class="data row4 col1" > 0.0107</td>
                        <td id="T_593a7_row4_col2" class="data row4 col2" >-5.57</td>
                        <td id="T_593a7_row4_col3" class="data row4 col3" >***</td>
                        <td id="T_593a7_row4_col4" class="data row4 col4" > 0.00</td>
            </tr>
            <tr>
                        <th id="T_593a7_level0_row5" class="row_heading level0 row5" >logsum</th>
                        <td id="T_593a7_row5_col0" class="data row5 col0" > 1.08</td>
                        <td id="T_593a7_row5_col1" class="data row5 col1" > 0.0316</td>
                        <td id="T_593a7_row5_col2" class="data row5 col2" > 34.22</td>
                        <td id="T_593a7_row5_col3" class="data row5 col3" >***</td>
                        <td id="T_593a7_row5_col4" class="data row5 col4" > 0.00</td>
            </tr>
    </tbody></table></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">estimation_statistics</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><table><thead><tr><th>Statistic</th><th>Aggregate</th><th>Per Case</th></tr><tr><td>Number of Cases</td><td colspan="2">7564</td></tr><tr><td>Log Likelihood at Convergence</td><td>-25287.53</td><td>-3.34</td></tr><tr><td>Log Likelihood at Null Parameters</td><td>-28238.34</td><td>-3.73</td></tr><tr><td>Rho Squared w.r.t. Null Parameters</td><td colspan="2">0.104</td></tr></thead><tbody></tbody></table></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">utility_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><table class="floatinghead" style="margin-top:1px;"><tr><td style="text-align:left;"><div></div> + <span class="LinearFunc_Param">P.logsum</span> * <span class="LinearFunc_Data">X.logsum</span><br> + <span class="LinearFunc_Param">P.distance</span> * <span class="LinearFunc_Data">X.distance</span><br> + log(<br>   + <span></span>exp(<span class="LinearFunc_Param">P.EmpRetail_HighInc</span>) * <span class="LinearFunc_Data">X('RETAIL_EMP * (INCOME&gt;50000)')</span><br>   + <span></span>exp(<span class="LinearFunc_Param">P.EmpNonRetail_HighInc</span>) * <span class="LinearFunc_Data">X('NONRETAIL_EMP*(INCOME&gt;50000)')</span><br>   + <span></span>exp(<span class="LinearFunc_Param">P.EmpRetail_LowInc</span>) * <span class="LinearFunc_Data">X('RETAIL_EMP*(INCOME&lt;=50000)')</span><br>   + <span></span>exp(<span class="LinearFunc_Param">P.EmpNonRetail_LowInc</span>) * <span class="LinearFunc_Data">X('NONRETAIL_EMP*(INCOME&lt;=50000)')</span><br>)</td></tr></table></div></div>
</div>
</div>
<div class="section" id="Model-Visualization">
<h2>Model Visualization<a class="headerlink" href="#Model-Visualization" title="Permalink to this headline">¶</a></h2>
<p>For destination choice and similar type models, it might be beneficial to review the observed and modeled choices, and the relative distribution of these choices across different factors. For example, we would probably want to see the distribution of travel distance. The <code class="docutils literal notranslate"><span class="pre">Model</span></code> object includes a built-in method to create this kind of visualization.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">distribution_on_idca_variable</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;AxesSubplot:xlabel=&#39;distance&#39;, ylabel=&#39;Relative Frequency&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/course-content_choice-modeling_103_exville_dest_53_1.png" src="../../_images/course-content_choice-modeling_103_exville_dest_53_1.png" />
</div>
</div>
<div class="section" id="Coincidence-Ratio">
<h3>Coincidence Ratio<a class="headerlink" href="#Coincidence-Ratio" title="Permalink to this headline">¶</a></h3>
<p>One way of checking trip length frequency distributions is through the use of coincidence ratios. This is most easily understood as the area under both curves divided by the area under at least one of the curves, when the observed and modeled trip length frequency distributions are plotted. Mathematically, the sum of the lower value of the two distributions at each increment of time or distance is divided by the sum of the higher value of the two distributions at each increment. Generally, the
coincidence ratio measures the percent of area that “coincides” for the two curves.</p>
<p>The procedure to calculate the coincidence of distributions is as follows:</p>
<div class="math notranslate nohighlight">
\[\frac
{\sum_T \min(PM_T,PO_T)}
{\sum_T \max(PM_T,PO_T)}\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(PM_T\)</span> is the proportion of modeled distribution in interval <span class="math notranslate nohighlight">\(T\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(PO_T\)</span> is the proportion of observed distribution in interval <span class="math notranslate nohighlight">\(T\)</span></p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">data_ca</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>

<span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">probability</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">y2</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">data_ch</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">bins</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coincidence_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">coincidence_ratio</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.9498246358767998
</pre></div></div>
</div>
</div>
<div class="section" id="Other-Distributions">
<h3>Other Distributions<a class="headerlink" href="#Other-Distributions" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">distribution_on_idca_variable</span><span class="p">(</span>
    <span class="n">m</span><span class="o">.</span><span class="n">dataservice</span><span class="o">.</span><span class="n">data_ca</span><span class="o">.</span><span class="n">TAZ_AREA_TYPE</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;AxesSubplot:xlabel=&#39;TAZ_AREA_TYPE&#39;, ylabel=&#39;Relative Frequency&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/course-content_choice-modeling_103_exville_dest_58_1.png" src="../../_images/course-content_choice-modeling_103_exville_dest_58_1.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">distribution_on_idca_variable</span></code> has a variety of options, for example to control the number and range of the histogram bins:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">distribution_on_idca_variable</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;AxesSubplot:xlabel=&#39;distance&#39;, ylabel=&#39;Relative Frequency&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/course-content_choice-modeling_103_exville_dest_60_1.png" src="../../_images/course-content_choice-modeling_103_exville_dest_60_1.png" />
</div>
</div>
<p>Alternatively, the histogram style can be swapped out for a smoothed <a class="reference external" href="https://en.wikipedia.org/wiki/Kernel_density_estimation">kernel density function</a>, by setting the <code class="docutils literal notranslate"><span class="pre">style</span></code> argument to <code class="docutils literal notranslate"><span class="pre">'kde'</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">distribution_on_idca_variable</span><span class="p">(</span>
    <span class="s1">&#39;distance&#39;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">,</span>
    <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">13</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;AxesSubplot:xlabel=&#39;distance&#39;, ylabel=&#39;Relative Frequency&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/course-content_choice-modeling_103_exville_dest_62_1.png" src="../../_images/course-content_choice-modeling_103_exville_dest_62_1.png" />
</div>
</div>
<p>Subsets of the observations can be pulled out, to observe the distribution conditional on other <em>idco</em> factors, like income.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">distribution_on_idca_variable</span><span class="p">(</span>
    <span class="s1">&#39;distance&#39;</span><span class="p">,</span>
    <span class="n">subselector</span><span class="o">=</span><span class="s1">&#39;INCOME&lt;10000&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;AxesSubplot:xlabel=&#39;distance&#39;, ylabel=&#39;Relative Frequency&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/course-content_choice-modeling_103_exville_dest_64_1.png" src="../../_images/course-content_choice-modeling_103_exville_dest_64_1.png" />
</div>
</div>
<p>It is also possible to customize some cosmetic parts of the generated figure, for example attaching a title or giving a more detailed and well formatted label for the x-axis.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">distribution_on_idca_variable</span><span class="p">(</span>
    <span class="s1">&#39;distance&#39;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Distance (miles)&quot;</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span>
    <span class="n">subselector</span><span class="o">=</span><span class="s1">&#39;INCOME&lt;10000&#39;</span><span class="p">,</span>
    <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">header</span><span class="o">=</span><span class="s1">&#39;Destination Distance, Very Low Income (&lt;$10k) Households&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;AxesSubplot:xlabel=&#39;Distance (miles)&#39;, ylabel=&#39;Relative Frequency&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/course-content_choice-modeling_103_exville_dest_66_1.png" src="../../_images/course-content_choice-modeling_103_exville_dest_66_1.png" />
</div>
</div>
<p>Alternatively, a <code class="docutils literal notranslate"><span class="pre">matplotlib.Axes</span></code> instance can be passed to the <code class="docutils literal notranslate"><span class="pre">distribution_on_idca_variable</span></code> function as the <code class="docutils literal notranslate"><span class="pre">ax</span></code> argument, and the figure will be drawn there. This allows full customizability of the rest of the figure using the usual matplotlib features.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="n">income_categories</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Low Income&#39;</span><span class="p">:</span> <span class="s1">&#39;INCOME&lt;10000&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Mid Income&#39;</span><span class="p">:</span> <span class="s1">&#39;(10000&lt;=INCOME) &amp; (INCOME&lt;50000)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;High Income&#39;</span><span class="p">:</span> <span class="s1">&#39;INCOME&gt;=50000&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">inc_title</span><span class="p">,</span> <span class="n">inc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">income_categories</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">distribution_on_idca_variable</span><span class="p">(</span>
        <span class="s1">&#39;distance&#39;</span><span class="p">,</span>
        <span class="n">subselector</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">13</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">inc_title</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/course-content_choice-modeling_103_exville_dest_68_0.png" src="../../_images/course-content_choice-modeling_103_exville_dest_68_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Save-and-Report-Model">
<h2>Save and Report Model<a class="headerlink" href="#Save-and-Report-Model" title="Permalink to this headline">¶</a></h2>
<p>If we are satisified with this model, or if we just want to record it as part of our workflow while exploring different model structures, we can write the model out to a report. To do so, we can instantiatie a <code class="docutils literal notranslate"><span class="pre">larch.Reporter</span></code> object.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span> <span class="o">=</span> <span class="n">larch</span><span class="o">.</span><span class="n">Reporter</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then, we can push section headings and report pieces into the report using the “&lt;&lt;” operator.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# Parameter Summary&#39;</span><span class="p">)</span>
<span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">parameter_summary</span><span class="p">())</span>
<span class="n">report</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<h1><a name="rx1" reftxt="Parameter Summary" class="toc" toclevel="1"></a>Parameter Summary</h1><div><style type="text/css">
    #T_8961c_ th {
          vertical-align: top;
          text-align: left;
    }    #T_8961c_ td {
          vertical-align: top;
          text-align: left;
    }#T_8961c_row0_col0,#T_8961c_row0_col1,#T_8961c_row0_col2,#T_8961c_row0_col3,#T_8961c_row0_col4,#T_8961c_row1_col0,#T_8961c_row1_col1,#T_8961c_row1_col2,#T_8961c_row1_col3,#T_8961c_row1_col4,#T_8961c_row2_col0,#T_8961c_row2_col1,#T_8961c_row2_col2,#T_8961c_row2_col3,#T_8961c_row2_col4,#T_8961c_row3_col0,#T_8961c_row3_col1,#T_8961c_row3_col2,#T_8961c_row3_col3,#T_8961c_row3_col4,#T_8961c_row4_col0,#T_8961c_row4_col1,#T_8961c_row4_col2,#T_8961c_row4_col3,#T_8961c_row4_col4,#T_8961c_row5_col0,#T_8961c_row5_col1,#T_8961c_row5_col2,#T_8961c_row5_col3,#T_8961c_row5_col4{
            font-family: monospace;
        }</style><table id="T_8961c_"><thead>    <tr>        <th class="blank level0"></th>        <th class="col_heading level0 col0">Value</th>        <th class="col_heading level0 col1">Std Err</th>        <th class="col_heading level0 col2">t Stat</th>        <th class="col_heading level0 col3">Signif</th>        <th class="col_heading level0 col4">Null Value</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_8961c_level0_row0" class="row_heading level0 row0">EmpNonRetail_HighInc</th>
                        <td id="T_8961c_row0_col0" class="data row0 col0"> 0.854</td>
                        <td id="T_8961c_row0_col1" class="data row0 col1"> 0.137</td>
                        <td id="T_8961c_row0_col2" class="data row0 col2"> 6.22</td>
                        <td id="T_8961c_row0_col3" class="data row0 col3">***</td>
                        <td id="T_8961c_row0_col4" class="data row0 col4"> 0.00</td>
            </tr>
            <tr>
                        <th id="T_8961c_level0_row1" class="row_heading level0 row1">EmpNonRetail_LowInc</th>
                        <td id="T_8961c_row1_col0" class="data row1 col0">-0.756</td>
                        <td id="T_8961c_row1_col1" class="data row1 col1"> 0.0615</td>
                        <td id="T_8961c_row1_col2" class="data row1 col2">-12.30</td>
                        <td id="T_8961c_row1_col3" class="data row1 col3">***</td>
                        <td id="T_8961c_row1_col4" class="data row1 col4"> 0.00</td>
            </tr>
            <tr>
                        <th id="T_8961c_level0_row2" class="row_heading level0 row2">EmpRetail_HighInc</th>
                        <td id="T_8961c_row2_col0" class="data row2 col0"> 0.00</td>
                        <td id="T_8961c_row2_col1" class="data row2 col1"> 0.00</td>
                        <td id="T_8961c_row2_col2" class="data row2 col2"> NA</td>
                        <td id="T_8961c_row2_col3" class="data row2 col3"></td>
                        <td id="T_8961c_row2_col4" class="data row2 col4"> 0.00</td>
            </tr>
            <tr>
                        <th id="T_8961c_level0_row3" class="row_heading level0 row3">EmpRetail_LowInc</th>
                        <td id="T_8961c_row3_col0" class="data row3 col0"> 0.00</td>
                        <td id="T_8961c_row3_col1" class="data row3 col1"> 0.00</td>
                        <td id="T_8961c_row3_col2" class="data row3 col2"> NA</td>
                        <td id="T_8961c_row3_col3" class="data row3 col3"></td>
                        <td id="T_8961c_row3_col4" class="data row3 col4"> 0.00</td>
            </tr>
            <tr>
                        <th id="T_8961c_level0_row4" class="row_heading level0 row4">distance</th>
                        <td id="T_8961c_row4_col0" class="data row4 col0">-0.0594</td>
                        <td id="T_8961c_row4_col1" class="data row4 col1"> 0.0107</td>
                        <td id="T_8961c_row4_col2" class="data row4 col2">-5.57</td>
                        <td id="T_8961c_row4_col3" class="data row4 col3">***</td>
                        <td id="T_8961c_row4_col4" class="data row4 col4"> 0.00</td>
            </tr>
            <tr>
                        <th id="T_8961c_level0_row5" class="row_heading level0 row5">logsum</th>
                        <td id="T_8961c_row5_col0" class="data row5 col0"> 1.08</td>
                        <td id="T_8961c_row5_col1" class="data row5 col1"> 0.0316</td>
                        <td id="T_8961c_row5_col2" class="data row5 col2"> 34.22</td>
                        <td id="T_8961c_row5_col3" class="data row5 col3">***</td>
                        <td id="T_8961c_row5_col4" class="data row5 col4"> 0.00</td>
            </tr>
    </tbody></table></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Estimation Statistics&quot;</span><span class="p">)</span>
<span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">estimation_statistics</span><span class="p">())</span>
<span class="n">report</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<h1><a name="rx2" reftxt="Estimation Statistics" class="toc" toclevel="1"></a>Estimation Statistics</h1><div><table><thead><tr><th>Statistic</th><th>Aggregate</th><th>Per Case</th></tr><tr><td>Number of Cases</td><td colspan="2">7564</td></tr><tr><td>Log Likelihood at Convergence</td><td>-25287.53</td><td>-3.34</td></tr><tr><td>Log Likelihood at Null Parameters</td><td>-28238.34</td><td>-3.73</td></tr><tr><td>Rho Squared w.r.t. Null Parameters</td><td colspan="2">0.104</td></tr></thead><tbody></tbody></table></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Utility Functions&quot;</span><span class="p">)</span>
<span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">utility_functions</span><span class="p">())</span>
<span class="n">report</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<h1><a name="rx3" reftxt="Utility Functions" class="toc" toclevel="1"></a>Utility Functions</h1><div><table class="floatinghead" style="margin-top:1px;"><tr><td style="text-align:left;"><div></div> + <span class="LinearFunc_Param">P.logsum</span> * <span class="LinearFunc_Data">X.logsum</span><br> + <span class="LinearFunc_Param">P.distance</span> * <span class="LinearFunc_Data">X.distance</span><br> + log(<br>   + <span></span>exp(<span class="LinearFunc_Param">P.EmpRetail_HighInc</span>) * <span class="LinearFunc_Data">X('RETAIL_EMP * (INCOME&gt;50000)')</span><br>   + <span></span>exp(<span class="LinearFunc_Param">P.EmpNonRetail_HighInc</span>) * <span class="LinearFunc_Data">X('NONRETAIL_EMP*(INCOME&gt;50000)')</span><br>   + <span></span>exp(<span class="LinearFunc_Param">P.EmpRetail_LowInc</span>) * <span class="LinearFunc_Data">X('RETAIL_EMP*(INCOME&lt;=50000)')</span><br>   + <span></span>exp(<span class="LinearFunc_Param">P.EmpNonRetail_LowInc</span>) * <span class="LinearFunc_Data">X('NONRETAIL_EMP*(INCOME&lt;=50000)')</span><br>)</td></tr></table></div></div>
</div>
<p>Once we have assembled the report, we can save the file to disk as an HTML report containing the content previously assembled. Attaching the model itself to the report as metadata can be done within the <code class="docutils literal notranslate"><span class="pre">save</span></code> method, which will allow us to directly reload the same model again later.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">report</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
    <span class="s1">&#39;/tmp/exampville_destination_choice.html&#39;</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">metadata</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;/tmp/exampville_destination_choice.html&#39;
</pre></div></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../exercises/_index.html" class="btn btn-neutral float-right" title="Exercises" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="102_exville_mc_logsums.html" class="btn btn-neutral float-left" title="Exampville Mode Choice Logsums" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>